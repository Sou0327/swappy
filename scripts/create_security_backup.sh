#!/bin/bash
# PostgreSQLã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰å‰ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

set -e

# ã‚«ãƒ©ãƒ¼å‡ºåŠ›ã®è¨­å®š
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# ç¾åœ¨ã®æ—¥æ™‚ã‚’å–å¾—
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="backups/security_upgrade_${TIMESTAMP}"

echo -e "${GREEN}ðŸ”’ Supabaseã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰å‰ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’é–‹å§‹${NC}"
echo "ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—: ${TIMESTAMP}"

# ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
mkdir -p "${BACKUP_DIR}"

echo -e "${YELLOW}ðŸ“‹ ç¾åœ¨ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è­¦å‘Šã‚’è¨˜éŒ²ä¸­...${NC}"
npx supabase db lint > "${BACKUP_DIR}/security_warnings_before.txt" 2>&1 || echo "è­¦å‘Šã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ" > "${BACKUP_DIR}/security_warnings_before.txt"

echo -e "${YELLOW}ðŸ’¾ å®Œå…¨ãªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ€ãƒ³ãƒ—ã‚’ä½œæˆä¸­...${NC}"
npx supabase db dump --file "${BACKUP_DIR}/full_database_backup.sql" || {
    echo -e "${RED}âŒ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ€ãƒ³ãƒ—ã«å¤±æ•—ã—ã¾ã—ãŸ${NC}"
    exit 1
}

echo -e "${YELLOW}ðŸ—ï¸ ã‚¹ã‚­ãƒ¼ãƒžã®ã¿ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä½œæˆä¸­...${NC}"
npx supabase db dump --data-only=false -s public -f "${BACKUP_DIR}/schema_backup.sql" || {
    echo -e "${RED}âŒ ã‚¹ã‚­ãƒ¼ãƒžãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã«å¤±æ•—ã—ã¾ã—ãŸ${NC}"
    exit 1
}

echo -e "${YELLOW}ðŸ“œ ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‚’è¨˜éŒ²ä¸­...${NC}"
npx supabase migration list > "${BACKUP_DIR}/migration_status.txt" 2>&1 || echo "ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹ã®å–å¾—ã«å¤±æ•—" > "${BACKUP_DIR}/migration_status.txt"

echo -e "${YELLOW}ðŸ“Š ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ã‚’è¨˜éŒ²ä¸­...${NC}"
npx supabase projects list > "${BACKUP_DIR}/project_info.txt" 2>&1 || echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ã®å–å¾—ã«å¤±æ•—" > "${BACKUP_DIR}/project_info.txt"

# ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æƒ…å ±ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
cat > "${BACKUP_DIR}/backup_info.md" << EOF
# Supabaseã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰å‰ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—

## ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æƒ…å ±
- ä½œæˆæ—¥æ™‚: $(date)
- ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—: ${TIMESTAMP}
- ä½œæˆç†ç”±: PostgreSQLã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰å‰ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—

## å«ã¾ã‚Œã‚‹ãƒ•ã‚¡ã‚¤ãƒ«
1. \`full_database_backup.sql\` - å®Œå…¨ãªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ€ãƒ³ãƒ—
2. \`schema_backup.sql\` - ã‚¹ã‚­ãƒ¼ãƒžã®ã¿ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
3. \`security_warnings_before.txt\` - ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰å‰ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è­¦å‘Š
4. \`migration_status.txt\` - ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹
5. \`project_info.txt\` - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±

## å¾©å…ƒæ–¹æ³•ï¼ˆç·Šæ€¥æ™‚ï¼‰
\`\`\`bash
# å®Œå…¨å¾©å…ƒï¼ˆæ³¨æ„: æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãŒå‰Šé™¤ã•ã‚Œã¾ã™ï¼‰
npx supabase db reset
cat full_database_backup.sql | npx supabase db push --stdin
\`\`\`

## ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰å‰ã®ç¢ºèªäº‹é …
- [ ] ã“ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒæ­£å¸¸ã«ä½œæˆã•ã‚ŒãŸ
- [ ] é–¢ä¿‚è€…ã¸ã®äº‹å‰é€šçŸ¥ãŒå®Œäº†ã—ãŸ
- [ ] ãƒ€ã‚¦ãƒ³ã‚¿ã‚¤ãƒ ã®æ‰¿èªãŒå¾—ã‚‰ã‚ŒãŸ
- [ ] ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †ãŒæº–å‚™ã•ã‚ŒãŸ

## ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰å¾Œã®ç¢ºèªé …ç›®
- [ ] ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æŽ¥ç¶šãŒæ­£å¸¸
- [ ] ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒæ­£å¸¸å‹•ä½œ
- [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è­¦å‘ŠãŒè§£æ±º
- [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ã«å•é¡Œãªã—
EOF

# ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã®ç¢ºèª
echo -e "${GREEN}ðŸ“ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º:${NC}"
ls -lh "${BACKUP_DIR}/"

echo -e "${GREEN}âœ… ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸ${NC}"
echo -e "${GREEN}ðŸ“‚ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å ´æ‰€: ${BACKUP_DIR}${NC}"

echo ""
echo -e "${YELLOW}âš ï¸  æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:${NC}"
echo "1. Supabaseãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ãƒ­ã‚°ã‚¤ãƒ³"
echo "2. OTPæœ‰åŠ¹æœŸé™ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ä¿è­·ã®è¨­å®šå¤‰æ›´ï¼ˆå³åº§å®Ÿè¡Œå¯èƒ½ï¼‰"
echo "3. PostgreSQLã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã®è¨ˆç”»ã¨ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°"
echo ""
echo -e "${GREEN}ðŸ”— è©³ç´°æ‰‹é †: Supabaseå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚ç…§${NC}"